import{k as M,u as $,y as J,D as T,m as G,F as V,r as d,j as e,L as j,e as W,B as y,C as H,G as v,I as P,T as K,H as Q,X as k,J as X,z as g}from"./index-55mznCYq.js";const Z=()=>{const{id:N}=M(),m=$(),{data:h}=J(),{data:x}=T(),{data:r,isLoading:E}=G(N),_=V(),[s,w]=d.useState({crop_id:"",quantity:"",unit:"kg",price:"",region_id:"",description:""}),[b,C]=d.useState([]),[q,L]=d.useState([]),[o,p]=d.useState([]),[u,S]=d.useState({});d.useEffect(()=>{var a,t,l,i;if(r){w({crop_id:((a=r.crop_id)==null?void 0:a.toString())||"",quantity:((t=r.quantity)==null?void 0:t.toString())||"",unit:r.unit||"kg",price:((l=r.price)==null?void 0:l.toString())||"",region_id:((i=r.region_id)==null?void 0:i.toString())||"",description:r.description||""});try{Array.isArray(r.images)?p(r.images):typeof r.images=="string"?p(JSON.parse(r.images)):p([])}catch{p([])}}},[r]);const I=(h==null?void 0:h.map(a=>({value:a.id,label:a.name})))||[],D=(x==null?void 0:x.map(a=>({value:a.id,label:a.name})))||[],U=[{value:"kg",label:"Kilograms (kg)"},{value:"ton",label:"Tons"},{value:"bag",label:"Bags"},{value:"crate",label:"Crates"},{value:"bunch",label:"Bunches"}],c=a=>{const{name:t,value:l}=a.target;w(i=>({...i,[t]:l})),u[t]&&S(i=>({...i,[t]:""}))},A=a=>{const t=Array.from(a.target.files);if(o.length+b.length+t.length>5){g.error("Maximum 5 images allowed");return}const i=t.filter(n=>["image/jpeg","image/png","image/webp"].includes(n.type)?n.size>5*1024*1024?(g.error(`${n.name} is too large (max 5MB)`),!1):!0:(g.error(`${n.name} is not a valid image type`),!1));C(n=>[...n,...i]),i.forEach(n=>{const f=new FileReader;f.onloadend=()=>{L(z=>[...z,f.result])},f.readAsDataURL(n)})},B=a=>{C(t=>t.filter((l,i)=>i!==a)),L(t=>t.filter((l,i)=>i!==a))},F=a=>{p(t=>t.filter((l,i)=>i!==a))},O=()=>{const a={};return s.crop_id||(a.crop_id="Crop type is required"),(!s.quantity||s.quantity<=0)&&(a.quantity="Valid quantity is required"),(!s.price||s.price<=0)&&(a.price="Valid price is required"),s.region_id||(a.region_id="Region is required"),S(a),Object.keys(a).length===0},R=async a=>{var l,i;if(a.preventDefault(),!O())return;const t=new FormData;t.append("crop_id",s.crop_id),t.append("quantity",s.quantity),t.append("unit",s.unit),t.append("price",s.price),t.append("region_id",s.region_id),t.append("description",s.description),t.append("existing_images",JSON.stringify(o)),b.forEach(n=>{t.append("images",n)});try{await _.mutateAsync({id:N,data:t}),g.success("Listing updated successfully!"),m("/farmer/my-listings")}catch(n){g.error(((i=(l=n.response)==null?void 0:l.data)==null?void 0:i.message)||"Failed to update listing")}};return E?e.jsx(j,{children:e.jsx(W,{})}):r?e.jsx(j,{children:e.jsxs("div",{className:"max-w-2xl mx-auto animate-fadeIn",children:[e.jsx("h1",{className:"page-title mb-6",children:"Edit Listing"}),e.jsx(H,{children:e.jsxs("form",{onSubmit:R,className:"space-y-6",children:[e.jsx(v,{label:"Crop Type *",name:"crop_id",value:s.crop_id,onChange:c,options:I,placeholder:"Select crop type",error:u.crop_id}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(P,{label:"Quantity *",name:"quantity",type:"number",step:"0.1",min:"0",value:s.quantity,onChange:c,placeholder:"e.g., 100",error:u.quantity}),e.jsx(v,{label:"Unit",name:"unit",value:s.unit,onChange:c,options:U})]}),e.jsx(P,{label:"Price per Unit (Pula) *",name:"price",type:"number",step:"0.01",min:"0",value:s.price,onChange:c,placeholder:"e.g., 10.00",error:u.price}),e.jsx(v,{label:"Location/Region *",name:"region_id",value:s.region_id,onChange:c,options:D,placeholder:"Select region",error:u.region_id}),e.jsx(K,{label:"Description",name:"description",value:s.description,onChange:c,placeholder:"Describe your produce (quality, freshness, farming method, etc.)",rows:4}),o.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"label",children:"Current Photos"}),e.jsx("div",{className:"flex flex-wrap gap-4",children:o.map((a,t)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:a.startsWith("http")?a:`${Q}/${a}`,alt:`Current ${t+1}`,className:"w-24 h-24 object-cover rounded-lg"}),e.jsx("button",{type:"button",onClick:()=>F(t),className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600",children:e.jsx(k,{size:14})})]},t))})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"label",children:["Add New Photos (Max ",5-o.length," more)"]}),e.jsxs("div",{className:"border-2 border-dashed border-neutral-300 rounded-lg p-6 text-center hover:border-primary-500 transition-colors",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/webp",multiple:!0,onChange:A,className:"hidden",id:"image-upload",disabled:o.length+b.length>=5}),e.jsxs("label",{htmlFor:"image-upload",className:"cursor-pointer",children:[e.jsx(X,{size:32,className:"mx-auto text-neutral-400 mb-2"}),e.jsx("p",{className:"text-neutral-600",children:"Click to upload images"}),e.jsx("p",{className:"text-sm text-neutral-400 mt-1",children:"JPEG, PNG, or WebP. Max 5MB each."})]})]}),q.length>0&&e.jsx("div",{className:"flex flex-wrap gap-4 mt-4",children:q.map((a,t)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:a,alt:`Preview ${t+1}`,className:"w-24 h-24 object-cover rounded-lg"}),e.jsx("button",{type:"button",onClick:()=>B(t),className:"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600",children:e.jsx(k,{size:14})})]},t))})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(y,{type:"button",variant:"outline",onClick:()=>m(-1),children:"Cancel"}),e.jsx(y,{type:"submit",loading:_.isPending,className:"flex-1",children:"Update Listing"})]})]})})]})}):e.jsx(j,{children:e.jsxs("div",{className:"text-center py-16",children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-700",children:"Listing not found"}),e.jsx(y,{variant:"outline",onClick:()=>m("/farmer/my-listings"),className:"mt-4",children:"Back to My Listings"})]})})};export{Z as default};
